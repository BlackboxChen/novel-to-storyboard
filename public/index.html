<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Story Flow - å°è¯´è½¬æ¼«å‰§å·¥ä½œæµ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    [x-cloak] { display: none !important; }
    .tab-btn.active { background-color: rgb(55, 65, 81); }
    .beat-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
    .clip-card { transition: all 0.2s ease; }
    .clip-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .prompt-box { font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div id="app" class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <header class="mb-6">
      <h1 class="text-3xl font-bold flex items-center gap-3">
        <span class="text-4xl">ğŸ¦</span>
        Story Flow
      </h1>
      <p class="text-gray-400 mt-2">å°è¯´ â†’ æ•…äº‹åœ£ç» â†’ åˆ†é›†æ¶æ„ â†’ å‰§æœ¬ â†’ åˆ†é•œ â†’ èµ„äº§</p>
    </header>

    <!-- Navigation -->
    <nav class="flex gap-2 mb-6 border-b border-gray-700 pb-4 flex-wrap">
      <button onclick="showTab('upload')" id="tab-upload" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700 active">
        ğŸ“¤ ä¸Šä¼ 
      </button>
      <button onclick="showTab('jobs')" id="tab-jobs" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ“‹ ä»»åŠ¡
      </button>
      <button onclick="showTab('storybible')" id="tab-storybible" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ“– æ•…äº‹åœ£ç»
      </button>
      <button onclick="showTab('architecture')" id="tab-architecture" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ—ï¸ åˆ†é›†æ¶æ„
      </button>
      <button onclick="showTab('script')" id="tab-script" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ¬ å‰§æœ¬
      </button>
      <button onclick="showTab('storyboard')" id="tab-storyboard" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ¥ åˆ†é•œ
      </button>
      <button onclick="showTab('assets')" id="tab-assets" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ¨ èµ„äº§
      </button>
    </nav>

    <!-- Upload Tab -->
    <div id="panel-upload" class="tab-panel">
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">ä¸Šä¼ å°è¯´æ–‡ä»¶</h2>

        <form id="upload-form" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">ä½œå“æ ‡é¢˜</label>
              <input type="text" id="novel-title" class="w-full bg-gray-700 rounded px-3 py-2" placeholder="å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æ–‡ä»¶å">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">è¾“å‡ºé£æ ¼</label>
              <select id="novel-style" class="w-full bg-gray-700 rounded px-3 py-2">
                <option value="narrated">è§£è¯´æ¼«ï¼ˆæ—ç™½é©±åŠ¨ï¼‰</option>
                <option value="storyboard">åˆ†æ ¼æ¼«å‰§ï¼ˆç”»é¢é©±åŠ¨ï¼‰</option>
              </select>
            </div>
          </div>

          <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-blue-500 transition-colors cursor-pointer"
               onclick="document.getElementById('file-input').click()"
               id="drop-zone">
            <input type="file" id="file-input" accept=".txt,.md" class="hidden" onchange="handleFileSelect(event)">
            <div class="text-4xl mb-2">ğŸ“„</div>
            <p class="text-gray-400">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å°è¯´æ–‡ä»¶ (.txt, .md)</p>
            <p id="file-name" class="text-blue-400 mt-2 hidden"></p>
          </div>

          <div>
            <label class="block text-sm text-gray-400 mb-1">æˆ–ç›´æ¥ç²˜è´´å†…å®¹</label>
            <textarea id="novel-content" class="w-full bg-gray-700 rounded px-3 py-2 h-40"
                      placeholder="ç²˜è´´å°è¯´æ–‡æœ¬..."></textarea>
          </div>

          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-medium transition-colors">
            å¼€å§‹å¤„ç†
          </button>
        </form>
      </div>
    </div>

    <!-- Jobs Tab -->
    <div id="panel-jobs" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">ä»»åŠ¡åˆ—è¡¨</h2>
          <button onclick="loadJobs()" class="text-sm bg-gray-700 px-3 py-1 rounded hover:bg-gray-600">
            ğŸ”„ åˆ·æ–°
          </button>
        </div>

        <div id="jobs-list" class="space-y-3">
          <p class="text-gray-500 text-center py-8">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- Story Bible Tab -->
    <div id="panel-storybible" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div id="storybible-placeholder" class="text-center py-12 text-gray-500">
          è¯·å…ˆä¸Šä¼ å¹¶è§£æå°è¯´
        </div>
        <div id="storybible-content" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">æ•…äº‹åœ£ç»</h2>
            <div class="flex gap-2">
              <button onclick="parseNovel()" id="btn-parse-sb" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                ğŸ“– è§£æå°è¯´
              </button>
            </div>
          </div>

          <!-- åŸºæœ¬ä¿¡æ¯ -->
          <div class="mb-6 p-4 bg-gray-700 rounded">
            <h3 class="font-medium mb-2">åŸºæœ¬ä¿¡æ¯</h3>
            <div class="grid grid-cols-3 gap-4 text-sm">
              <div>
                <span class="text-gray-400">ä¸»é¢˜ï¼š</span>
                <span id="sb-theme">-</span>
              </div>
              <div>
                <span class="text-gray-400">é¢„ä¼°é›†æ•°ï¼š</span>
                <span id="sb-episodes">-</span>
              </div>
              <div>
                <span class="text-gray-400">æ°›å›´ï¼š</span>
                <span id="sb-tone">-</span>
              </div>
            </div>
          </div>

          <!-- è§’è‰²åˆ—è¡¨ -->
          <div class="mb-6">
            <h3 class="font-medium mb-3">è§’è‰² (<span id="sb-char-count">0</span>)</h3>
            <div id="sb-characters" class="grid grid-cols-2 gap-3"></div>
          </div>

          <!-- äº‹ä»¶åˆ—è¡¨ -->
          <div class="mb-6">
            <h3 class="font-medium mb-3">äº‹ä»¶ (<span id="sb-event-count">0</span>)</h3>
            <div id="sb-events" class="space-y-2 max-h-96 overflow-y-auto"></div>
          </div>

          <!-- åŸå‹åˆ†å¸ƒ -->
          <div class="p-4 bg-gray-700 rounded">
            <h3 class="font-medium mb-2">åŸå‹åˆ†å¸ƒ</h3>
            <div id="sb-archetypes" class="flex gap-2 flex-wrap"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Architecture Tab -->
    <div id="panel-architecture" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div id="arch-placeholder" class="text-center py-12 text-gray-500">
          è¯·å…ˆç”Ÿæˆæ•…äº‹åœ£ç»
        </div>
        <div id="arch-content" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">åˆ†é›†æ¶æ„</h2>
            <div class="flex gap-2">
              <button onclick="generateArchitecture()" id="btn-arch" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                ğŸ—ï¸ ç”Ÿæˆæ¶æ„
              </button>
            </div>
          </div>

          <!-- æ¦‚è§ˆ -->
          <div class="mb-6 p-4 bg-gray-700 rounded">
            <div class="grid grid-cols-4 gap-4 text-center">
              <div>
                <div class="text-2xl font-bold text-blue-400" id="arch-total">-</div>
                <div class="text-sm text-gray-400">æ€»é›†æ•°</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-green-400" id="arch-events">-</div>
                <div class="text-sm text-gray-400">äº‹ä»¶æ•°</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-purple-400" id="arch-beats">-</div>
                <div class="text-sm text-gray-400">çˆ½ç‚¹æ•°</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-yellow-400" id="arch-formula">-</div>
                <div class="text-sm text-gray-400">è®¡ç®—å…¬å¼</div>
              </div>
            </div>
          </div>

          <!-- åˆ†é›†åˆ—è¡¨ -->
          <div id="arch-episodes" class="space-y-4"></div>
        </div>
      </div>
    </div>

    <!-- Script Tab -->
    <div id="panel-script" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div id="script-placeholder" class="text-center py-12 text-gray-500">
          è¯·å…ˆç”Ÿæˆåˆ†é›†æ¶æ„
        </div>
        <div id="script-content" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">å‰§æœ¬</h2>
            <div class="flex gap-2">
              <button onclick="generateScript()" id="btn-script" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded">
                ğŸ¬ ç”Ÿæˆå‰§æœ¬
              </button>
              <button onclick="exportJob('json')" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                ğŸ“¥ å¯¼å‡º
              </button>
            </div>
          </div>

          <div id="script-episodes" class="space-y-4"></div>
        </div>
      </div>
    </div>

    <!-- Storyboard Tab -->
    <div id="panel-storyboard" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div id="storyboard-placeholder" class="text-center py-12 text-gray-500">
          è¯·å…ˆç”Ÿæˆå‰§æœ¬
        </div>
        <div id="storyboard-content" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">åˆ†é•œ</h2>
            <div class="flex gap-2">
              <select id="style-preset" class="bg-gray-700 rounded px-3 py-2 text-sm">
                <option value="neutral_cinematic">Neutral Cinematic</option>
                <option value="hitchcock">Hitchcock</option>
                <option value="tarkovsky">Tarkovsky</option>
                <option value="wong_kar_wai">Wong Kar-wai</option>
                <option value="kubrick">Kubrick</option>
                <option value="kurosawa">Kurosawa</option>
              </select>
              <button onclick="generateStoryboard()" id="btn-storyboard" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
                ğŸ¥ ç”Ÿæˆåˆ†é•œ
              </button>
            </div>
          </div>

          <div id="storyboard-episodes" class="space-y-6"></div>
        </div>
      </div>
    </div>

    <!-- Assets Tab -->
    <div id="panel-assets" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div id="assets-placeholder" class="text-center py-12 text-gray-500">
          è¯·å…ˆç”Ÿæˆæ•…äº‹åœ£ç»
        </div>
        <div id="assets-content" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">èµ„äº§</h2>
            <div class="flex gap-2">
              <button onclick="generateAssets()" id="btn-assets" class="bg-pink-600 hover:bg-pink-700 px-4 py-2 rounded">
                ğŸ¨ ç”Ÿæˆèµ„äº§
              </button>
            </div>
          </div>

          <!-- èµ„äº§åˆ†ç±» -->
          <div class="grid grid-cols-3 gap-6">
            <!-- è§’è‰²èµ„äº§ -->
            <div class="bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium mb-3">ğŸ‘¤ è§’è‰²èµ„äº§</h3>
              <div id="assets-characters" class="space-y-2"></div>
            </div>

            <!-- åœºæ™¯èµ„äº§ -->
            <div class="bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium mb-3">ğŸï¸ åœºæ™¯èµ„äº§</h3>
              <div id="assets-scenes" class="space-y-2"></div>
            </div>

            <!-- é“å…·èµ„äº§ -->
            <div class="bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium mb-3">ğŸ“¦ é“å…·èµ„äº§</h3>
              <div id="assets-props" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div id="status-bar" class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-3 hidden">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div id="status-message" class="text-sm"></div>
        <button onclick="hideStatus()" class="text-gray-400 hover:text-white">âœ•</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentJob = null;

    // çŠ¶æ€æ˜ å°„
    const STATUS_MAP = {
      'uploaded': 'å·²ä¸Šä¼ ',
      'parsing': 'è§£æä¸­...',
      'parsed': 'å·²è§£æ',
      'architecting': 'æ¶æ„è®¾è®¡ä¸­...',
      'architected': 'æ¶æ„å®Œæˆ',
      'generating_script': 'å‰§æœ¬ç”Ÿæˆä¸­...',
      'script_ready': 'å‰§æœ¬å°±ç»ª',
      'generating_storyboard': 'åˆ†é•œç”Ÿæˆä¸­...',
      'storyboard_ready': 'åˆ†é•œå°±ç»ª',
      'generating_assets': 'èµ„äº§ç”Ÿæˆä¸­...',
      'assets_ready': 'èµ„äº§å°±ç»ª'
    };

    // åŸå‹é¢œè‰²
    const ARCHETYPE_COLORS = {
      'underdog': 'bg-blue-600',
      'hidden_identity': 'bg-purple-600',
      'gray': 'bg-gray-500',
      'oppressor': 'bg-red-600',
      'wildcard': 'bg-yellow-600',
      'ally': 'bg-green-600'
    };

    // çˆ½ç‚¹é¢œè‰²
    const BEAT_COLORS = {
      'slap': 'bg-red-500',
      'upgrade': 'bg-green-500',
      'revenge': 'bg-orange-500',
      'identity': 'bg-purple-500',
      'info': 'bg-blue-500',
      'comeback': 'bg-yellow-500',
      'emotion': 'bg-pink-500'
    };

    // Tab switching
    function showTab(tabName) {
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`panel-${tabName}`).classList.remove('hidden');
      document.getElementById(`tab-${tabName}`).classList.add('active');

      if (tabName === 'jobs') loadJobs();
      if (tabName === 'storybible') updateStoryBibleTab();
      if (tabName === 'architecture') updateArchitectureTab();
      if (tabName === 'script') updateScriptTab();
      if (tabName === 'storyboard') updateStoryboardTab();
      if (tabName === 'assets') updateAssetsTab();
    }

    // File handling
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-name').classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('novel-content').value = e.target.result;
        };
        reader.readAsText(file);
      }
    }

    // Drag and drop
    const dropZone = document.getElementById('drop-zone');
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-blue-500');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('border-blue-500');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-500');
      const file = e.dataTransfer.files[0];
      if (file) {
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-name').classList.remove('hidden');
        const reader = new FileReader();
        reader.onload = (ev) => {
          document.getElementById('novel-content').value = ev.target.result;
        };
        reader.readAsText(file);
      }
    });

    // Upload form
    document.getElementById('upload-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = document.getElementById('novel-title').value;
      const style = document.getElementById('novel-style').value;
      const content = document.getElementById('novel-content').value;

      if (!content.trim()) {
        alert('è¯·ä¸Šä¼ æ–‡ä»¶æˆ–ç²˜è´´å°è¯´å†…å®¹');
        return;
      }

      showStatus('ä¸Šä¼ ä¸­...');

      try {
        const response = await fetch(`${API_BASE}/api/novel/upload`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, style, content })
        });

        const data = await response.json();
        if (data.jobId) {
          currentJob = { id: data.jobId, title: data.title };
          hideStatus();
          showTab('storybible');
          loadJob(data.jobId);
        } else {
          showStatus('ä¸Šä¼ å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('è¯·æ±‚å¤±è´¥ï¼š' + err.message, true);
      }
    });

    // Load jobs list
    async function loadJobs() {
      const listEl = document.getElementById('jobs-list');
      listEl.innerHTML = '<p class="text-gray-500 text-center py-8">åŠ è½½ä¸­...</p>';

      try {
        const response = await fetch(`${API_BASE}/api/jobs`);
        const data = await response.json();

        if (data.jobs.length === 0) {
          listEl.innerHTML = '<p class="text-gray-500 text-center py-8">æš‚æ— ä»»åŠ¡</p>';
          return;
        }

        listEl.innerHTML = data.jobs.map(job => `
          <div class="bg-gray-700 rounded-lg p-4 flex justify-between items-center">
            <div>
              <h3 class="font-medium">${job.title}</h3>
              <p class="text-sm text-gray-400">${STATUS_MAP[job.status] || job.status} Â· ${new Date(job.createdAt).toLocaleString()}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="loadAndEdit('${job.id}')" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                ç¼–è¾‘
              </button>
              <button onclick="deleteJob('${job.id}')" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                åˆ é™¤
              </button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        listEl.innerHTML = `<p class="text-red-400 text-center py-8">åŠ è½½å¤±è´¥ï¼š${err.message}</p>`;
      }
    }

    // Load and edit job
    async function loadAndEdit(jobId) {
      await loadJob(jobId);
      showTab('storybible');
    }

    // Load single job
    async function loadJob(jobId) {
      try {
        const response = await fetch(`${API_BASE}/api/jobs/${jobId}`);
        currentJob = await response.json();
        updateAllTabs();
      } catch (err) {
        console.error('Load job error:', err);
      }
    }

    // Delete job
    async function deleteJob(jobId) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ')) return;

      try {
        await fetch(`${API_BASE}/api/jobs/${jobId}`, { method: 'DELETE' });
        loadJobs();
      } catch (err) {
        alert('åˆ é™¤å¤±è´¥ï¼š' + err.message);
      }
    }

    // Parse novel
    async function parseNovel() {
      if (!currentJob) return;

      const btn = document.getElementById('btn-parse-sb');
      btn.textContent = 'ğŸ“– è§£æä¸­...';
      btn.disabled = true;

      showStatus('æ­£åœ¨è§£æå°è¯´ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...');

      try {
        const response = await fetch(`${API_BASE}/api/novel/parse/${currentJob.id}`, {
          method: 'POST'
        });

        const data = await response.json();

        if (response.ok) {
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateStoryBibleTab();
          showStatus('è§£æå®Œæˆï¼');
        } else {
          showStatus('è§£æå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('è§£æå¤±è´¥ï¼š' + err.message, true);
      }

      btn.textContent = 'ğŸ“– è§£æå°è¯´';
      btn.disabled = false;
    }

    // Generate architecture
    async function generateArchitecture() {
      if (!currentJob || !currentJob.storyBible) return;

      const btn = document.getElementById('btn-arch');
      btn.textContent = 'ğŸ—ï¸ ç”Ÿæˆä¸­...';
      btn.disabled = true;

      showStatus('æ­£åœ¨ç”Ÿæˆåˆ†é›†æ¶æ„...');

      try {
        const response = await fetch(`${API_BASE}/api/architecture/generate/${currentJob.id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok) {
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateArchitectureTab();
          showStatus('æ¶æ„ç”Ÿæˆå®Œæˆï¼');
        } else {
          showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + err.message, true);
      }

      btn.textContent = 'ğŸ—ï¸ ç”Ÿæˆæ¶æ„';
      btn.disabled = false;
    }

    // Generate script
    async function generateScript() {
      if (!currentJob || !currentJob.architecture) return;

      const btn = document.getElementById('btn-script');
      btn.textContent = 'ğŸ¬ ç”Ÿæˆä¸­...';
      btn.disabled = true;

      showStatus('æ­£åœ¨ç”Ÿæˆå‰§æœ¬...');

      try {
        const response = await fetch(`${API_BASE}/api/script/generate/${currentJob.id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok) {
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateScriptTab();
          showStatus('å‰§æœ¬ç”Ÿæˆå®Œæˆï¼');
        } else {
          showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + err.message, true);
      }

      btn.textContent = 'ğŸ¬ ç”Ÿæˆå‰§æœ¬';
      btn.disabled = false;
    }

    // Generate storyboard
    async function generateStoryboard() {
      if (!currentJob || !currentJob.script) return;

      const btn = document.getElementById('btn-storyboard');
      btn.textContent = 'ğŸ¥ ç”Ÿæˆä¸­...';
      btn.disabled = true;

      const stylePreset = document.getElementById('style-preset').value;
      showStatus('æ­£åœ¨ç”Ÿæˆåˆ†é•œ...');

      try {
        const response = await fetch(`${API_BASE}/api/storyboard/generate/${currentJob.id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: 'A', stylePreset })
        });

        const data = await response.json();

        if (response.ok) {
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateStoryboardTab();
          showStatus('åˆ†é•œç”Ÿæˆå®Œæˆï¼');
        } else {
          showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + err.message, true);
      }

      btn.textContent = 'ğŸ¥ ç”Ÿæˆåˆ†é•œ';
      btn.disabled = false;
    }

    // Generate assets
    async function generateAssets() {
      if (!currentJob || !currentJob.storyBible) return;

      const btn = document.getElementById('btn-assets');
      btn.textContent = 'ğŸ¨ ç”Ÿæˆä¸­...';
      btn.disabled = true;

      showStatus('æ­£åœ¨ç”Ÿæˆèµ„äº§...');

      try {
        const response = await fetch(`${API_BASE}/api/asset/generate/${currentJob.id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok) {
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateAssetsTab();
          showStatus('èµ„äº§ç”Ÿæˆå®Œæˆï¼');
        } else {
          showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + err.message, true);
      }

      btn.textContent = 'ğŸ¨ ç”Ÿæˆèµ„äº§';
      btn.disabled = false;
    }

    // Update all tabs
    function updateAllTabs() {
      updateStoryBibleTab();
      updateArchitectureTab();
      updateScriptTab();
      updateStoryboardTab();
      updateAssetsTab();
    }

    // Update Story Bible Tab
    function updateStoryBibleTab() {
      const placeholder = document.getElementById('storybible-placeholder');
      const content = document.getElementById('storybible-content');

      if (!currentJob) {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
        return;
      }

      placeholder.classList.add('hidden');
      content.classList.remove('hidden');

      const sb = currentJob.storyBible;
      if (!sb) return;

      // åŸºæœ¬ä¿¡æ¯
      document.getElementById('sb-theme').textContent = sb.mainTheme || '-';
      document.getElementById('sb-episodes').textContent = sb.estimatedEpisodes || '-';
      document.getElementById('sb-tone').textContent = (sb.toneKeywords || []).join(', ') || '-';

      // è§’è‰²
      const charCount = (sb.characters || []).length;
      document.getElementById('sb-char-count').textContent = charCount;

      document.getElementById('sb-characters').innerHTML = (sb.characters || []).map(c => `
        <div class="bg-gray-700 rounded p-3">
          <div class="flex justify-between items-start mb-2">
            <span class="font-medium">${c.name}</span>
            <span class="text-xs px-2 py-1 rounded ${ARCHETYPE_COLORS[c.archetype] || 'bg-gray-600'}">${c._archetypeName || c.archetype || c.role}</span>
          </div>
          <p class="text-sm text-gray-400">${(c.traits || []).slice(0, 3).join(' Â· ')}</p>
          ${c.desires ? `<p class="text-xs text-gray-500 mt-1">æ¬²æœ›: ${c.desires}</p>` : ''}
        </div>
      `).join('');

      // äº‹ä»¶
      const eventCount = (sb.events || []).length;
      document.getElementById('sb-event-count').textContent = eventCount;

      document.getElementById('sb-events').innerHTML = (sb.events || []).slice(0, 20).map(e => `
        <div class="bg-gray-700 rounded p-2 flex items-center gap-2">
          <span class="text-xs font-mono text-gray-500">${e.id}</span>
          <span class="flex-1 text-sm">${e.summary || e.description || ''}</span>
          <span class="text-xs px-2 py-0.5 rounded ${e.type === 'load_bearing' ? 'bg-red-600' : e.type === 'reinforcing' ? 'bg-blue-600' : 'bg-gray-600'}">${e.type}</span>
          ${(e.beatPotential || []).map(b => `<span class="beat-badge ${BEAT_COLORS[b] || 'bg-gray-500'}">${b}</span>`).join('')}
        </div>
      `).join('');

      // åŸå‹åˆ†å¸ƒ
      const archetypeCounts = {};
      (sb.characters || []).forEach(c => {
        const a = c.archetype || 'unknown';
        archetypeCounts[a] = (archetypeCounts[a] || 0) + 1;
      });

      document.getElementById('sb-archetypes').innerHTML = Object.entries(archetypeCounts).map(([a, count]) => `
        <span class="px-3 py-1 rounded ${ARCHETYPE_COLORS[a] || 'bg-gray-600'}">${a}: ${count}</span>
      `).join('');
    }

    // Update Architecture Tab
    function updateArchitectureTab() {
      const placeholder = document.getElementById('arch-placeholder');
      const content = document.getElementById('arch-content');

      if (!currentJob || !currentJob.storyBible) {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
        return;
      }

      placeholder.classList.add('hidden');
      content.classList.remove('hidden');

      const arch = currentJob.architecture;
      if (!arch) return;

      // æ¦‚è§ˆ
      document.getElementById('arch-total').textContent = arch.totalEpisodes || '-';
      document.getElementById('arch-events').textContent = (currentJob.storyBible.events || []).length;
      document.getElementById('arch-beats').textContent = Object.values(arch.beatDistribution || {}).reduce((a, b) => a + b, 0);
      document.getElementById('arch-formula').textContent = arch.formula ? arch.formula.split('=')[1]?.trim() || arch.formula : '-';

      // åˆ†é›†åˆ—è¡¨
      document.getElementById('arch-episodes').innerHTML = (arch.episodes || []).map(ep => `
        <div class="bg-gray-700 rounded-lg p-4">
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-medium">ç¬¬ ${ep.number} é›†: ${ep.title || 'æœªå‘½å'}</h4>
            <span class="text-sm text-gray-400">${ep.emotionalArc || ''}</span>
          </div>
          <p class="text-sm text-gray-300 mb-3">${ep.logline || 'æ— å–ç‚¹'}</p>
          <div class="flex gap-2 flex-wrap">
            ${Object.entries(ep.beatMap || {}).filter(([_, v]) => v && v.type).map(([pos, v]) => `
              <span class="text-xs px-2 py-1 rounded ${BEAT_COLORS[v.type] || 'bg-gray-500'}">${pos}: ${v.type}</span>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // Update Script Tab
    function updateScriptTab() {
      const placeholder = document.getElementById('script-placeholder');
      const content = document.getElementById('script-content');

      if (!currentJob || !currentJob.architecture) {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
        return;
      }

      placeholder.classList.add('hidden');
      content.classList.remove('hidden');

      const script = currentJob.script;
      if (!script || !script.episodes?.length) {
        document.getElementById('script-episodes').innerHTML = '<p class="text-gray-500 text-center py-8">ç‚¹å‡»"ç”Ÿæˆå‰§æœ¬"å¼€å§‹</p>';
        return;
      }

      document.getElementById('script-episodes').innerHTML = script.episodes.map(ep => `
        <div class="bg-gray-700 rounded-lg p-4">
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-medium">ç¬¬ ${ep.number} é›†</h4>
            <span class="text-sm text-gray-400">${ep.metadata?.generatedAt ? new Date(ep.metadata.generatedAt).toLocaleString() : ''}</span>
          </div>
          <div class="prose prose-invert max-w-none">
            <pre class="whitespace-pre-wrap text-sm bg-gray-800 p-3 rounded">${ep.content || 'ï¼ˆç©ºï¼‰'}</pre>
          </div>
        </div>
      `).join('');
    }

    // Update Storyboard Tab
    function updateStoryboardTab() {
      const placeholder = document.getElementById('storyboard-placeholder');
      const content = document.getElementById('storyboard-content');

      if (!currentJob || !currentJob.script) {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
        return;
      }

      placeholder.classList.add('hidden');
      content.classList.remove('hidden');

      const storyboard = currentJob.storyboard;
      if (!storyboard || !storyboard.episodes?.length) {
        document.getElementById('storyboard-episodes').innerHTML = '<p class="text-gray-500 text-center py-8">ç‚¹å‡»"ç”Ÿæˆåˆ†é•œ"å¼€å§‹</p>';
        return;
      }

      document.getElementById('storyboard-episodes').innerHTML = storyboard.episodes.map(ep => `
        <div class="bg-gray-700 rounded-lg p-4">
          <h4 class="font-medium mb-4">ç¬¬ ${ep.episodeNumber} é›† - ${ep.clips?.length || 0} ä¸ªç‰‡æ®µ</h4>
          <div class="grid grid-cols-2 gap-4">
            ${(ep.clips || []).slice(0, 6).map(clip => `
              <div class="clip-card bg-gray-800 rounded p-3">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium">${clip.id}: ${clip.title}</span>
                  <span class="text-xs text-gray-500">${clip.duration?.total || 0}s</span>
                </div>
                <p class="text-xs text-gray-400 mb-2">${clip.emotion || ''}</p>
                <div class="prompt-box text-xs text-gray-300 bg-gray-900 p-2 rounded max-h-32 overflow-y-auto">${(clip.prompt?.combined || '').slice(0, 200)}...</div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // Update Assets Tab
    function updateAssetsTab() {
      const placeholder = document.getElementById('assets-placeholder');
      const content = document.getElementById('assets-content');

      if (!currentJob || !currentJob.storyBible) {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
        return;
      }

      placeholder.classList.add('hidden');
      content.classList.remove('hidden');

      const assets = currentJob.assets;
      if (!assets) {
        document.getElementById('assets-characters').innerHTML = '<p class="text-gray-500 text-sm">ç‚¹å‡»"ç”Ÿæˆèµ„äº§"</p>';
        document.getElementById('assets-scenes').innerHTML = '<p class="text-gray-500 text-sm">ç‚¹å‡»"ç”Ÿæˆèµ„äº§"</p>';
        document.getElementById('assets-props').innerHTML = '<p class="text-gray-500 text-sm">ç‚¹å‡»"ç”Ÿæˆèµ„äº§"</p>';
        return;
      }

      // è§’è‰²èµ„äº§
      document.getElementById('assets-characters').innerHTML = (assets.characters || []).map(c => `
        <div class="bg-gray-600 rounded p-2">
          <div class="font-medium text-sm mb-1">${c.characterName}</div>
          <div class="text-xs text-gray-400">ç‚¹å‡»æŸ¥çœ‹æç¤ºè¯</div>
        </div>
      `).join('') || '<p class="text-gray-500 text-sm">æš‚æ— è§’è‰²èµ„äº§</p>';

      // åœºæ™¯èµ„äº§
      document.getElementById('assets-scenes').innerHTML = (assets.scenes || []).map(s => `
        <div class="bg-gray-600 rounded p-2">
          <div class="font-medium text-sm mb-1">${s.sceneName}</div>
          <div class="text-xs text-gray-400">${s.mood || ''}</div>
        </div>
      `).join('') || '<p class="text-gray-500 text-sm">æš‚æ— åœºæ™¯èµ„äº§</p>';

      // é“å…·èµ„äº§
      document.getElementById('assets-props').innerHTML = '<p class="text-gray-500 text-sm">æš‚æ— é“å…·èµ„äº§</p>';
    }

    // Export
    function exportJob(format) {
      if (!currentJob) return;
      window.open(`${API_BASE}/api/export/${currentJob.id}/${format}`, '_blank');
    }

    // Status bar
    function showStatus(message, isError = false) {
      const statusBar = document.getElementById('status-bar');
      const statusMessage = document.getElementById('status-message');
      statusBar.classList.remove('hidden');
      statusMessage.textContent = message;
      statusMessage.className = isError ? 'text-red-400' : 'text-gray-300';
    }

    function hideStatus() {
      document.getElementById('status-bar').classList.add('hidden');
    }

    // Initialize
    showTab('upload');
  </script>
</body>
</html>
