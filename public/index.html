<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Story Flow - å°è¯´è½¬æ¼«å‰§å·¥ä½œæµ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    [x-cloak] { display: none !important; }
    .tab-btn.active { background-color: rgb(55, 65, 81); }
    .beat-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
    .clip-card { transition: all 0.2s ease; }
    .clip-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .prompt-box { font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div id="app" class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <header class="mb-6">
      <h1 class="text-3xl font-bold flex items-center gap-3">
        <span class="text-4xl">ğŸ¦</span>
        Story Flow
      </h1>
      <p class="text-gray-400 mt-2">å°è¯´ â†’ æ•…äº‹åœ£ç» â†’ åˆ†é›†æ¶æ„ â†’ å‰§æœ¬ â†’ åˆ†é•œ â†’ èµ„äº§</p>
    </header>

    <!-- Navigation -->
    <nav class="flex gap-2 mb-6 border-b border-gray-700 pb-4 flex-wrap">
      <button onclick="showTab('upload')" id="tab-upload" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700 active">
        ğŸ“¤ ä¸Šä¼ 
      </button>
      <button onclick="showTab('jobs')" id="tab-jobs" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ“‹ ä»»åŠ¡
      </button>
      <button onclick="showTab('storybible')" id="tab-storybible" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ“– æ•…äº‹åœ£ç»
      </button>
      <button onclick="showTab('architecture')" id="tab-architecture" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ—ï¸ åˆ†é›†æ¶æ„
      </button>
      <button onclick="showTab('script')" id="tab-script" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ¬ å‰§æœ¬
      </button>
      <button onclick="showTab('storyboard')" id="tab-storyboard" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ¥ åˆ†é•œ
      </button>
      <button onclick="showTab('assets')" id="tab-assets" class="tab-btn px-4 py-2 rounded font-medium hover:bg-gray-700">
        ğŸ¨ èµ„äº§
      </button>
    </nav>

    <!-- Upload Tab -->
    <div id="panel-upload" class="tab-panel">
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">ä¸Šä¼ å°è¯´æ–‡ä»¶</h2>

        <form id="upload-form" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">ä½œå“æ ‡é¢˜</label>
              <input type="text" id="novel-title" class="w-full bg-gray-700 rounded px-3 py-2" placeholder="å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æ–‡ä»¶å">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">è¾“å‡ºé£æ ¼</label>
              <select id="novel-style" class="w-full bg-gray-700 rounded px-3 py-2">
                <option value="narrated">è§£è¯´æ¼«ï¼ˆæ—ç™½é©±åŠ¨ï¼‰</option>
                <option value="storyboard">åˆ†æ ¼æ¼«å‰§ï¼ˆç”»é¢é©±åŠ¨ï¼‰</option>
              </select>
            </div>
          </div>

          <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-blue-500 transition-colors cursor-pointer"
               onclick="document.getElementById('file-input').click()"
               id="drop-zone">
            <input type="file" id="file-input" accept=".txt,.md" class="hidden" onchange="handleFileSelect(event)">
            <div class="text-4xl mb-2">ğŸ“„</div>
            <p class="text-gray-400">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å°è¯´æ–‡ä»¶ (.txt, .md)</p>
            <p id="file-name" class="text-blue-400 mt-2 hidden"></p>
          </div>

          <div>
            <label class="block text-sm text-gray-400 mb-1">æˆ–ç›´æ¥ç²˜è´´å†…å®¹</label>
            <textarea id="novel-content" class="w-full bg-gray-700 rounded px-3 py-2 h-40"
                      placeholder="ç²˜è´´å°è¯´æ–‡æœ¬..."></textarea>
          </div>

          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-medium transition-colors">
            å¼€å§‹å¤„ç†
          </button>
        </form>
      </div>
    </div>

    <!-- Jobs Tab -->
    <div id="panel-jobs" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">ä»»åŠ¡åˆ—è¡¨</h2>
          <button onclick="loadJobs()" class="text-sm bg-gray-700 px-3 py-1 rounded hover:bg-gray-600">
            ğŸ”„ åˆ·æ–°
          </button>
        </div>

        <div id="jobs-list" class="space-y-3">
          <p class="text-gray-500 text-center py-8">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- Story Bible Tab -->
    <div id="panel-storybible" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div id="storybible-placeholder" class="text-center py-12 text-gray-500">
          è¯·å…ˆä¸Šä¼ å¹¶è§£æå°è¯´
        </div>
        <div id="storybible-content" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">æ•…äº‹åœ£ç»</h2>
            <div class="flex gap-2">
              <button onclick="parseNovel()" id="btn-parse-sb" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                ğŸ“– è§£æå°è¯´
              </button>
            </div>
          </div>

          <!-- åŸºæœ¬ä¿¡æ¯ -->
          <div class="mb-6 p-4 bg-gray-700 rounded">
            <h3 class="font-medium mb-2">åŸºæœ¬ä¿¡æ¯</h3>
            <div class="grid grid-cols-3 gap-4 text-sm">
              <div>
                <span class="text-gray-400">ä¸»é¢˜ï¼š</span>
                <span id="sb-theme">-</span>
              </div>
              <div>
                <span class="text-gray-400">é¢„ä¼°é›†æ•°ï¼š</span>
                <span id="sb-episodes">-</span>
              </div>
              <div>
                <span class="text-gray-400">æ°›å›´ï¼š</span>
                <span id="sb-tone">-</span>
              </div>
            </div>
          </div>

          <!-- è§’è‰²åˆ—è¡¨ -->
          <div class="mb-6">
            <h3 class="font-medium mb-3">è§’è‰² (<span id="sb-char-count">0</span>)</h3>
            <div id="sb-characters" class="grid grid-cols-2 gap-3"></div>
          </div>

          <!-- äº‹ä»¶åˆ—è¡¨ -->
          <div class="mb-6">
            <h3 class="font-medium mb-3">äº‹ä»¶ (<span id="sb-event-count">0</span>)</h3>
            <div id="sb-events" class="space-y-2 max-h-96 overflow-y-auto"></div>
          </div>

          <!-- åŸå‹åˆ†å¸ƒ -->
          <div class="p-4 bg-gray-700 rounded">
            <h3 class="font-medium mb-2">åŸå‹åˆ†å¸ƒ</h3>
            <div id="sb-archetypes" class="flex gap-2 flex-wrap"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Architecture Tab -->
    <div id="panel-architecture" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div id="arch-placeholder" class="text-center py-12 text-gray-500">
          è¯·å…ˆç”Ÿæˆæ•…äº‹åœ£ç»
        </div>
        <div id="arch-content" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">åˆ†é›†æ¶æ„</h2>
            <div class="flex gap-2">
              <button onclick="generateArchitecture()" id="btn-arch" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                ğŸ—ï¸ ç”Ÿæˆæ¶æ„
              </button>
            </div>
          </div>

          <!-- æ¦‚è§ˆ -->
          <div class="mb-6 p-4 bg-gray-700 rounded">
            <div class="grid grid-cols-4 gap-4 text-center">
              <div>
                <div class="text-2xl font-bold text-blue-400" id="arch-total">-</div>
                <div class="text-sm text-gray-400">æ€»é›†æ•°</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-green-400" id="arch-events">-</div>
                <div class="text-sm text-gray-400">äº‹ä»¶æ•°</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-purple-400" id="arch-beats">-</div>
                <div class="text-sm text-gray-400">çˆ½ç‚¹æ•°</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-yellow-400" id="arch-formula">-</div>
                <div class="text-sm text-gray-400">è®¡ç®—å…¬å¼</div>
              </div>
            </div>
          </div>

          <!-- åˆ†é›†åˆ—è¡¨ -->
          <div id="arch-episodes" class="space-y-4"></div>
        </div>
      </div>
    </div>

    <!-- Script Tab -->
    <div id="panel-script" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div id="script-placeholder" class="text-center py-12 text-gray-500">
          è¯·å…ˆç”Ÿæˆåˆ†é›†æ¶æ„
        </div>
        <div id="script-content" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">å‰§æœ¬</h2>
            <div class="flex gap-2">
              <button onclick="generateScript()" id="btn-script" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded">
                ğŸ¬ ç”Ÿæˆå‰§æœ¬
              </button>
              <button onclick="exportJob('json')" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                ğŸ“¥ å¯¼å‡º
              </button>
            </div>
          </div>

          <div id="script-episodes" class="space-y-4"></div>
        </div>
      </div>
    </div>

    <!-- Storyboard Tab -->
    <div id="panel-storyboard" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div id="storyboard-placeholder" class="text-center py-12 text-gray-500">
          è¯·å…ˆç”Ÿæˆå‰§æœ¬
        </div>
        <div id="storyboard-content" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">åˆ†é•œ</h2>
            <div class="flex gap-2 items-center">
              <select id="style-preset" class="bg-gray-700 rounded px-3 py-2 text-sm">
                <option value="neutral_cinematic">Neutral Cinematic</option>
                <option value="hitchcock">Hitchcock</option>
                <option value="tarkovsky">Tarkovsky</option>
                <option value="wong_kar_wai">Wong Kar-wai</option>
                <option value="kubrick">Kubrick</option>
                <option value="kurosawa">Kurosawa</option>
              </select>
              <button onclick="generateStoryboard()" id="btn-storyboard" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
                ğŸ¥ ç”Ÿæˆåˆ†é•œ
              </button>
              <button onclick="stopStoryboard()" id="btn-stop-storyboard" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded hidden">
                â¹ï¸ åœæ­¢
              </button>
              <span id="storyboard-progress" class="text-sm text-gray-400"></span>
            </div>
          </div>

          <div id="storyboard-episodes" class="space-y-6"></div>
        </div>
      </div>
    </div>

    <!-- Assets Tab -->
    <div id="panel-assets" class="tab-panel hidden">
      <div class="bg-gray-800 rounded-lg p-6">
        <div id="assets-placeholder" class="text-center py-12 text-gray-500">
          è¯·å…ˆç”Ÿæˆæ•…äº‹åœ£ç»
        </div>
        <div id="assets-content" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">èµ„äº§</h2>
            <div class="flex gap-2">
              <button onclick="generateAssets()" id="btn-assets" class="bg-pink-600 hover:bg-pink-700 px-4 py-2 rounded">
                ğŸ¨ ç”Ÿæˆèµ„äº§
              </button>
            </div>
          </div>

          <!-- èµ„äº§åˆ†ç±» -->
          <div class="grid grid-cols-3 gap-6">
            <!-- è§’è‰²èµ„äº§ -->
            <div class="bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium mb-3">ğŸ‘¤ è§’è‰²èµ„äº§</h3>
              <div id="assets-characters" class="space-y-2"></div>
            </div>

            <!-- åœºæ™¯èµ„äº§ -->
            <div class="bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium mb-3">ğŸï¸ åœºæ™¯èµ„äº§</h3>
              <div id="assets-scenes" class="space-y-2"></div>
            </div>

            <!-- é“å…·èµ„äº§ -->
            <div class="bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium mb-3">ğŸ“¦ é“å…·èµ„äº§</h3>
              <div id="assets-props" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div id="status-bar" class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-3 hidden">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div id="status-message" class="text-sm"></div>
        <button onclick="hideStatus()" class="text-gray-400 hover:text-white">âœ•</button>
      </div>
    </div>

    <!-- èµ„äº§è¯¦æƒ…å¼¹çª— -->
    <div id="asset-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
      <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
          <h3 id="modal-title" class="text-lg font-semibold">èµ„äº§è¯¦æƒ…</h3>
          <button onclick="closeAssetModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div id="modal-content" class="p-4">
          <!-- åŠ¨æ€å†…å®¹ -->
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentJob = null;

    // çŠ¶æ€æ˜ å°„
    const STATUS_MAP = {
      'uploaded': 'å·²ä¸Šä¼ ',
      'parsing': 'è§£æä¸­...',
      'parsed': 'å·²è§£æ',
      'architecting': 'æ¶æ„è®¾è®¡ä¸­...',
      'architected': 'æ¶æ„å®Œæˆ',
      'generating_script': 'å‰§æœ¬ç”Ÿæˆä¸­...',
      'script_ready': 'å‰§æœ¬å°±ç»ª',
      'generating_storyboard': 'åˆ†é•œç”Ÿæˆä¸­...',
      'storyboard_ready': 'åˆ†é•œå°±ç»ª',
      'generating_assets': 'èµ„äº§ç”Ÿæˆä¸­...',
      'assets_ready': 'èµ„äº§å°±ç»ª'
    };

    // åŸå‹é¢œè‰²
    const ARCHETYPE_COLORS = {
      'underdog': 'bg-blue-600',
      'hidden_identity': 'bg-purple-600',
      'gray': 'bg-gray-500',
      'oppressor': 'bg-red-600',
      'wildcard': 'bg-yellow-600',
      'ally': 'bg-green-600'
    };

    // çˆ½ç‚¹é¢œè‰²
    const BEAT_COLORS = {
      'slap': 'bg-red-500',
      'upgrade': 'bg-green-500',
      'revenge': 'bg-orange-500',
      'identity': 'bg-purple-500',
      'info': 'bg-blue-500',
      'comeback': 'bg-yellow-500',
      'emotion': 'bg-pink-500'
    };

    // Tab switching
    function showTab(tabName) {
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`panel-${tabName}`).classList.remove('hidden');
      document.getElementById(`tab-${tabName}`).classList.add('active');

      if (tabName === 'jobs') loadJobs();
      if (tabName === 'storybible') updateStoryBibleTab();
      if (tabName === 'architecture') updateArchitectureTab();
      if (tabName === 'script') updateScriptTab();
      if (tabName === 'storyboard') updateStoryboardTab();
      if (tabName === 'assets') updateAssetsTab();
    }

    // File handling
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-name').classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('novel-content').value = e.target.result;
        };
        reader.readAsText(file);
      }
    }

    // Drag and drop
    const dropZone = document.getElementById('drop-zone');
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-blue-500');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('border-blue-500');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-500');
      const file = e.dataTransfer.files[0];
      if (file) {
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-name').classList.remove('hidden');
        const reader = new FileReader();
        reader.onload = (ev) => {
          document.getElementById('novel-content').value = ev.target.result;
        };
        reader.readAsText(file);
      }
    });

    // Upload form
    document.getElementById('upload-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = document.getElementById('novel-title').value;
      const style = document.getElementById('novel-style').value;
      const content = document.getElementById('novel-content').value;

      if (!content.trim()) {
        alert('è¯·ä¸Šä¼ æ–‡ä»¶æˆ–ç²˜è´´å°è¯´å†…å®¹');
        return;
      }

      showStatus('ä¸Šä¼ ä¸­...');

      try {
        const response = await fetch(`${API_BASE}/api/novel/upload`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, style, content })
        });

        const data = await response.json();
        if (data.jobId) {
          currentJob = { id: data.jobId, title: data.title };
          hideStatus();
          showTab('storybible');
          loadJob(data.jobId);
        } else {
          showStatus('ä¸Šä¼ å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('è¯·æ±‚å¤±è´¥ï¼š' + err.message, true);
      }
    });

    // Load jobs list
    async function loadJobs() {
      const listEl = document.getElementById('jobs-list');
      listEl.innerHTML = '<p class="text-gray-500 text-center py-8">åŠ è½½ä¸­...</p>';

      try {
        const response = await fetch(`${API_BASE}/api/jobs`);
        const data = await response.json();

        if (data.jobs.length === 0) {
          listEl.innerHTML = '<p class="text-gray-500 text-center py-8">æš‚æ— ä»»åŠ¡</p>';
          return;
        }

        listEl.innerHTML = data.jobs.map(job => `
          <div class="bg-gray-700 rounded-lg p-4 flex justify-between items-center">
            <div>
              <h3 class="font-medium">${job.title}</h3>
              <p class="text-sm text-gray-400">${STATUS_MAP[job.status] || job.status} Â· ${new Date(job.createdAt).toLocaleString()}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="loadAndEdit('${job.id}')" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                ç¼–è¾‘
              </button>
              <button onclick="deleteJob('${job.id}')" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                åˆ é™¤
              </button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        listEl.innerHTML = `<p class="text-red-400 text-center py-8">åŠ è½½å¤±è´¥ï¼š${err.message}</p>`;
      }
    }

    // Load and edit job
    async function loadAndEdit(jobId) {
      await loadJob(jobId);
      showTab('storybible');
    }

    // Load single job
    async function loadJob(jobId) {
      try {
        const response = await fetch(`${API_BASE}/api/jobs/${jobId}`);
        currentJob = await response.json();
        updateAllTabs();
      } catch (err) {
        console.error('Load job error:', err);
      }
    }

    // Delete job
    async function deleteJob(jobId) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ')) return;

      try {
        await fetch(`${API_BASE}/api/jobs/${jobId}`, { method: 'DELETE' });
        loadJobs();
      } catch (err) {
        alert('åˆ é™¤å¤±è´¥ï¼š' + err.message);
      }
    }

    // Parse novel
    async function parseNovel() {
      if (!currentJob) return;

      const btn = document.getElementById('btn-parse-sb');
      btn.textContent = 'ğŸ“– è§£æä¸­...';
      btn.disabled = true;

      showStatus('æ­£åœ¨è§£æå°è¯´ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...');

      try {
        const response = await fetch(`${API_BASE}/api/novel/parse/${currentJob.id}`, {
          method: 'POST'
        });

        const data = await response.json();

        if (response.ok) {
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateStoryBibleTab();
          showStatus('è§£æå®Œæˆï¼');
        } else {
          showStatus('è§£æå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('è§£æå¤±è´¥ï¼š' + err.message, true);
      }

      btn.textContent = 'ğŸ“– è§£æå°è¯´';
      btn.disabled = false;
    }

    // Generate architecture
    async function generateArchitecture() {
      if (!currentJob || !currentJob.storyBible) return;

      const btn = document.getElementById('btn-arch');
      btn.textContent = 'ğŸ—ï¸ ç”Ÿæˆä¸­...';
      btn.disabled = true;

      showStatus('æ­£åœ¨ç”Ÿæˆåˆ†é›†æ¶æ„...');

      try {
        const response = await fetch(`${API_BASE}/api/architecture/generate/${currentJob.id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok) {
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateArchitectureTab();
          showStatus('æ¶æ„ç”Ÿæˆå®Œæˆï¼');
        } else {
          showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + err.message, true);
      }

      btn.textContent = 'ğŸ—ï¸ ç”Ÿæˆæ¶æ„';
      btn.disabled = false;
    }

    // Generate script
    async function generateScript() {
      if (!currentJob || !currentJob.architecture) return;

      const btn = document.getElementById('btn-script');
      btn.textContent = 'ğŸ¬ ç”Ÿæˆä¸­...';
      btn.disabled = true;

      showStatus('æ­£åœ¨ç”Ÿæˆå‰§æœ¬...');

      try {
        const response = await fetch(`${API_BASE}/api/script/generate/${currentJob.id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok) {
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateScriptTab();
          showStatus('å‰§æœ¬ç”Ÿæˆå®Œæˆï¼');
        } else {
          showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + err.message, true);
      }

      btn.textContent = 'ğŸ¬ ç”Ÿæˆå‰§æœ¬';
      btn.disabled = false;
    }

    // Storyboard generation state
    let storyboardGenerating = false;
    let storyboardEventSource = null;

    // Generate storyboard with SSE streaming
    async function generateStoryboard() {
      if (!currentJob || !currentJob.script) return;

      const btn = document.getElementById('btn-storyboard');
      const stopBtn = document.getElementById('btn-stop-storyboard');
      const progressSpan = document.getElementById('storyboard-progress');

      btn.textContent = 'ğŸ¥ ç”Ÿæˆä¸­...';
      btn.disabled = true;
      stopBtn.classList.remove('hidden');
      storyboardGenerating = true;
      progressSpan.textContent = 'æ­£åœ¨è¿æ¥...';

      const stylePreset = document.getElementById('style-preset').value;
      showStatus('æ­£åœ¨ç”Ÿæˆåˆ†é•œï¼ˆæ‰¹é‡æ¨¡å¼ + å®æ—¶å“åº”ï¼‰...');

      // ä½¿ç”¨ SSE æµå¼å“åº”
      const url = `${API_BASE}/api/storyboard/generate/${currentJob.id}/stream?mode=A&stylePreset=${stylePreset}&useLLM=true`;
      storyboardEventSource = new EventSource(url);

      let completedEpisodes = 0;
      let totalEpisodes = 0;

      // å¼€å§‹äº‹ä»¶
      storyboardEventSource.addEventListener('start', (e) => {
        const data = JSON.parse(e.data);
        totalEpisodes = data.totalEpisodes;
        progressSpan.textContent = `å¼€å§‹å¤„ç† ${totalEpisodes} é›†...`;
        console.log('[SSE] å¼€å§‹:', data);
      });

      // è¿›åº¦äº‹ä»¶
      storyboardEventSource.addEventListener('progress', (e) => {
        const data = JSON.parse(e.data);
        progressSpan.textContent = `æ­£åœ¨å¤„ç†ç¬¬ ${data.episodeNumber} é›†...`;
      });

      // å•é›†å®Œæˆäº‹ä»¶
      storyboardEventSource.addEventListener('episode', (e) => {
        const data = JSON.parse(e.data);
        completedEpisodes++;

        progressSpan.textContent = `ç¬¬ ${data.episodeNumber} é›†å®Œæˆ (${data.clipsCount} ç‰‡æ®µ)ï¼Œè€—æ—¶ ${(data.elapsed / 1000).toFixed(1)}s`;

        // å®æ—¶æ›´æ–°åˆ†é•œæ˜¾ç¤º
        if (data.storyboard) {
          if (!currentJob.storyboard) {
            currentJob.storyboard = { episodes: [], failedEpisodes: [] };
          }
          if (!Array.isArray(currentJob.storyboard.failedEpisodes)) {
            currentJob.storyboard.failedEpisodes = [];
          }

          const existingIndex = currentJob.storyboard.episodes.findIndex(ep => ep.episodeNumber === data.episodeNumber);
          if (existingIndex >= 0) {
            currentJob.storyboard.episodes[existingIndex] = data.storyboard;
          } else {
            currentJob.storyboard.episodes.push(data.storyboard);
            currentJob.storyboard.episodes.sort((a, b) => a.episodeNumber - b.episodeNumber);
          }
          currentJob.storyboard.failedEpisodes = currentJob.storyboard.failedEpisodes.filter(
            f => f.episodeNumber !== data.episodeNumber
          );

          // å®æ—¶æ›´æ–° UI
          updateStoryboardTab();
        }

        console.log(`[SSE] ç¬¬ ${data.episodeNumber} é›†å®Œæˆ:`, data);
      });

      // å•é›†é”™è¯¯äº‹ä»¶
      storyboardEventSource.addEventListener('episode_error', (e) => {
        const data = JSON.parse(e.data);
        console.error(`[SSE] ç¬¬ ${data.episodeNumber} é›†å¤±è´¥:`, data.error);
        if (!currentJob.storyboard) {
          currentJob.storyboard = { episodes: [], failedEpisodes: [] };
        }
        if (!Array.isArray(currentJob.storyboard.failedEpisodes)) {
          currentJob.storyboard.failedEpisodes = [];
        }

        const failure = {
          episodeNumber: data.episodeNumber,
          error: data.error,
          failedAt: new Date().toISOString()
        };
        const failureIndex = currentJob.storyboard.failedEpisodes.findIndex(
          f => f.episodeNumber === data.episodeNumber
        );
        if (failureIndex >= 0) {
          currentJob.storyboard.failedEpisodes[failureIndex] = failure;
        } else {
          currentJob.storyboard.failedEpisodes.push(failure);
        }

        updateStoryboardTab();
        showStatus(`ç¬¬ ${data.episodeNumber} é›†ç”Ÿæˆå¤±è´¥ï¼š${data.error}`, true);
      });

      // å®Œæˆäº‹ä»¶
      storyboardEventSource.addEventListener('complete', (e) => {
        const data = JSON.parse(e.data);
        const failedCount = Array.isArray(data.failedEpisodes) ? data.failedEpisodes.length : 0;

        progressSpan.textContent = `å·²å®Œæˆ ${data.completedEpisodes}/${data.totalEpisodes} é›†ï¼Œæ€»è€—æ—¶ ${(data.totalElapsed / 1000).toFixed(1)}s`;

        // åˆ·æ–°å®Œæ•´çš„ job æ•°æ®
        fetch(`${API_BASE}/api/jobs/${currentJob.id}`)
          .then(res => res.json())
          .then(job => {
            currentJob = job;
            updateStoryboardTab();
          });

        if (failedCount > 0) {
          showStatus(`åˆ†é•œç”Ÿæˆå®Œæˆï¼šæˆåŠŸ ${data.completedEpisodes} é›†ï¼Œå¤±è´¥ ${failedCount} é›†ï¼ˆå¯å•ç‹¬é‡è¯•ï¼‰`, true);
        } else {
          showStatus(`åˆ†é•œç”Ÿæˆå®Œæˆï¼å…± ${data.completedEpisodes} é›†`);
        }
        console.log('[SSE] å®Œæˆ:', data);

        // æ¸…ç†
        storyboardEventSource.close();
        storyboardEventSource = null;
        btn.textContent = 'ğŸ¥ ç”Ÿæˆåˆ†é•œ';
        btn.disabled = false;
        stopBtn.classList.add('hidden');
        storyboardGenerating = false;
      });

      // é”™è¯¯äº‹ä»¶
      storyboardEventSource.addEventListener('error', (e) => {
        if (e.data) {
          const data = JSON.parse(e.data);
          showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + data.error, true);
          progressSpan.textContent = 'ç”Ÿæˆå¤±è´¥';
        } else {
          showStatus('è¿æ¥ä¸­æ–­', true);
          progressSpan.textContent = 'è¿æ¥ä¸­æ–­';
        }

        console.error('[SSE] é”™è¯¯:', e);

        storyboardEventSource.close();
        storyboardEventSource = null;
        btn.textContent = 'ğŸ¥ ç”Ÿæˆåˆ†é•œ';
        btn.disabled = false;
        stopBtn.classList.add('hidden');
        storyboardGenerating = false;
      });

      // è¿æ¥é”™è¯¯
      storyboardEventSource.onerror = (err) => {
        if (storyboardEventSource.readyState === EventSource.CLOSED) {
          return; // æ­£å¸¸å…³é—­
        }

        console.error('[SSE] è¿æ¥é”™è¯¯:', err);
        showStatus('è¿æ¥æœåŠ¡å™¨å¤±è´¥', true);
        progressSpan.textContent = 'è¿æ¥å¤±è´¥';

        storyboardEventSource.close();
        storyboardEventSource = null;
        btn.textContent = 'ğŸ¥ ç”Ÿæˆåˆ†é•œ';
        btn.disabled = false;
        stopBtn.classList.add('hidden');
        storyboardGenerating = false;
      };
    }

    // Stop storyboard generation
    async function stopStoryboard() {
      if (!storyboardGenerating) return;

      const btn = document.getElementById('btn-storyboard');
      const stopBtn = document.getElementById('btn-stop-storyboard');
      const progressSpan = document.getElementById('storyboard-progress');

      try {
        // å…³é—­ SSE è¿æ¥
        if (storyboardEventSource) {
          storyboardEventSource.close();
          storyboardEventSource = null;
        }

        // è°ƒç”¨åç«¯åœæ­¢æ¥å£
        await fetch(`${API_BASE}/api/storyboard/abort/${currentJob.id}`, {
          method: 'POST'
        });

        progressSpan.textContent = 'å·²åœæ­¢';
        showStatus('åˆ†é•œç”Ÿæˆå·²åœæ­¢');
      } catch (err) {
        console.error('åœæ­¢å¤±è´¥:', err);
      }

      btn.textContent = 'ğŸ¥ ç”Ÿæˆåˆ†é•œ';
      btn.disabled = false;
      stopBtn.classList.add('hidden');
      storyboardGenerating = false;
    }

    // Regenerate single episode storyboard
    async function regenerateStoryboardEpisode(episodeNumber) {
      if (!currentJob || !currentJob.script) return;
      if (storyboardGenerating) {
        showStatus('å½“å‰æœ‰åˆ†é•œä»»åŠ¡åœ¨æ‰§è¡Œï¼Œè¯·å…ˆåœæ­¢åå†é‡è¯•å•é›†', true);
        return;
      }

      const btn = document.getElementById(`btn-storyboard-regen-${episodeNumber}`);
      if (btn) {
        btn.textContent = 'â³ é‡è¯•ä¸­...';
        btn.disabled = true;
      }

      const stylePreset = document.getElementById('style-preset').value;
      showStatus(`æ­£åœ¨é‡è¯•ç¬¬ ${episodeNumber} é›†åˆ†é•œ...`);

      try {
        const response = await fetch(`${API_BASE}/api/storyboard/generate/${currentJob.id}/episode/${episodeNumber}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'A',
            stylePreset,
            useLLM: true,
            useBatch: true
          })
        });

        const data = await response.json();
        if (response.ok) {
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateStoryboardTab();
          showStatus(`ç¬¬ ${episodeNumber} é›†åˆ†é•œå·²é‡æ–°ç”Ÿæˆ`);
        } else {
          showStatus(`ç¬¬ ${episodeNumber} é›†é‡è¯•å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`, true);
        }
      } catch (err) {
        showStatus(`ç¬¬ ${episodeNumber} é›†é‡è¯•å¤±è´¥ï¼š${err.message}`, true);
      }

      if (btn) {
        btn.textContent = 'ğŸ”„ é‡è¯•æœ¬é›†';
        btn.disabled = false;
      }
    }

    // Generate assets
    async function generateAssets() {
      if (!currentJob || !currentJob.storyBible) return;

      const btn = document.getElementById('btn-assets');
      btn.textContent = 'ğŸ¨ ç”Ÿæˆä¸­...';
      btn.disabled = true;

      showStatus('æ­£åœ¨ç”Ÿæˆèµ„äº§...');

      try {
        const response = await fetch(`${API_BASE}/api/asset/generate/${currentJob.id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok) {
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateAssetsTab();
          showStatus('èµ„äº§ç”Ÿæˆå®Œæˆï¼');
        } else {
          showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + err.message, true);
      }

      btn.textContent = 'ğŸ¨ ç”Ÿæˆèµ„äº§';
      btn.disabled = false;
    }

    // Update all tabs
    function updateAllTabs() {
      updateStoryBibleTab();
      updateArchitectureTab();
      updateScriptTab();
      updateStoryboardTab();
      updateAssetsTab();
    }

    // Update Story Bible Tab
    function updateStoryBibleTab() {
      const placeholder = document.getElementById('storybible-placeholder');
      const content = document.getElementById('storybible-content');

      if (!currentJob) {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
        return;
      }

      placeholder.classList.add('hidden');
      content.classList.remove('hidden');

      const sb = currentJob.storyBible;
      if (!sb) return;

      // åŸºæœ¬ä¿¡æ¯
      document.getElementById('sb-theme').textContent = sb.mainTheme || '-';
      document.getElementById('sb-episodes').textContent = sb.estimatedEpisodes || '-';
      document.getElementById('sb-tone').textContent = (sb.toneKeywords || []).join(', ') || '-';

      // è§’è‰²
      const charCount = (sb.characters || []).length;
      document.getElementById('sb-char-count').textContent = charCount;

      document.getElementById('sb-characters').innerHTML = (sb.characters || []).map(c => `
        <div class="bg-gray-700 rounded p-3">
          <div class="flex justify-between items-start mb-2">
            <span class="font-medium">${c.name}</span>
            <span class="text-xs px-2 py-1 rounded ${ARCHETYPE_COLORS[c.archetype] || 'bg-gray-600'}">${c._archetypeName || c.archetype || c.role}</span>
          </div>
          <p class="text-sm text-gray-400">${(c.traits || []).slice(0, 3).join(' Â· ')}</p>
          ${c.desires ? `<p class="text-xs text-gray-500 mt-1">æ¬²æœ›: ${c.desires}</p>` : ''}
        </div>
      `).join('');

      // äº‹ä»¶
      const eventCount = (sb.events || []).length;
      document.getElementById('sb-event-count').textContent = eventCount;

      document.getElementById('sb-events').innerHTML = (sb.events || []).slice(0, 20).map(e => `
        <div class="bg-gray-700 rounded p-2 flex items-center gap-2">
          <span class="text-xs font-mono text-gray-500">${e.id}</span>
          <span class="flex-1 text-sm">${e.summary || e.description || ''}</span>
          <span class="text-xs px-2 py-0.5 rounded ${e.type === 'load_bearing' ? 'bg-red-600' : e.type === 'reinforcing' ? 'bg-blue-600' : 'bg-gray-600'}">${e.type}</span>
          ${(e.beatPotential || []).map(b => `<span class="beat-badge ${BEAT_COLORS[b] || 'bg-gray-500'}">${b}</span>`).join('')}
        </div>
      `).join('');

      // åŸå‹åˆ†å¸ƒ
      const archetypeCounts = {};
      (sb.characters || []).forEach(c => {
        const a = c.archetype || 'unknown';
        archetypeCounts[a] = (archetypeCounts[a] || 0) + 1;
      });

      document.getElementById('sb-archetypes').innerHTML = Object.entries(archetypeCounts).map(([a, count]) => `
        <span class="px-3 py-1 rounded ${ARCHETYPE_COLORS[a] || 'bg-gray-600'}">${a}: ${count}</span>
      `).join('');
    }

    // Update Architecture Tab
    function updateArchitectureTab() {
      const placeholder = document.getElementById('arch-placeholder');
      const content = document.getElementById('arch-content');

      if (!currentJob || !currentJob.storyBible) {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
        return;
      }

      placeholder.classList.add('hidden');
      content.classList.remove('hidden');

      const arch = currentJob.architecture;
      if (!arch) return;

      // æ¦‚è§ˆ
      document.getElementById('arch-total').textContent = arch.totalEpisodes || '-';
      document.getElementById('arch-events').textContent = (currentJob.storyBible.events || []).length;
      document.getElementById('arch-beats').textContent = Object.values(arch.beatDistribution || {}).reduce((a, b) => a + b, 0);
      document.getElementById('arch-formula').textContent = arch.formula ? arch.formula.split('=')[1]?.trim() || arch.formula : '-';

      // åˆ†é›†åˆ—è¡¨
      document.getElementById('arch-episodes').innerHTML = (arch.episodes || []).map(ep => `
        <div class="bg-gray-700 rounded-lg p-4">
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-medium">ç¬¬ ${ep.number} é›†: ${ep.title || 'æœªå‘½å'}</h4>
            <span class="text-sm text-gray-400">${ep.emotionalArc || ''}</span>
          </div>
          <p class="text-sm text-gray-300 mb-3">${ep.logline || 'æ— å–ç‚¹'}</p>
          <div class="flex gap-2 flex-wrap">
            ${Object.entries(ep.beatMap || {}).filter(([_, v]) => v && v.type).map(([pos, v]) => `
              <span class="text-xs px-2 py-1 rounded ${BEAT_COLORS[v.type] || 'bg-gray-500'}">${pos}: ${v.type}</span>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // Update Script Tab
    function updateScriptTab() {
      const placeholder = document.getElementById('script-placeholder');
      const content = document.getElementById('script-content');

      if (!currentJob || !currentJob.architecture) {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
        return;
      }

      placeholder.classList.add('hidden');
      content.classList.remove('hidden');

      const script = currentJob.script;
      if (!script || !script.episodes?.length) {
        document.getElementById('script-episodes').innerHTML = '<p class="text-gray-500 text-center py-8">ç‚¹å‡»"ç”Ÿæˆå‰§æœ¬"å¼€å§‹</p>';
        return;
      }

      document.getElementById('script-episodes').innerHTML = script.episodes.map(ep => `
        <div class="bg-gray-700 rounded-lg p-4" id="script-ep-${ep.number}">
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-medium">ç¬¬ ${ep.number} é›†${ep.title ? `: ${ep.title}` : ''}</h4>
            <div class="flex items-center gap-2">
              ${ep.metadata?.fallback ? '<span class="text-xs bg-yellow-600 px-2 py-1 rounded">é™çº§ç‰ˆ</span>' : ''}
              ${ep.error ? '<span class="text-xs bg-red-600 px-2 py-1 rounded">é”™è¯¯</span>' : ''}
              <button onclick="showRegenerateModal(${ep.number})" class="text-xs bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded" id="btn-regen-${ep.number}">
                ğŸ”„ é‡æ–°ç”Ÿæˆ
              </button>
              <span class="text-sm text-gray-400">${ep.metadata?.generatedAt ? new Date(ep.metadata.generatedAt).toLocaleString() : ''}</span>
            </div>
          </div>
          <div class="prose prose-invert max-w-none">
            <pre class="whitespace-pre-wrap text-sm bg-gray-800 p-3 rounded">${ep.content || 'ï¼ˆå†…å®¹ä¸ºç©ºï¼Œè¯·é‡æ–°ç”Ÿæˆï¼‰'}</pre>
          </div>
          ${ep.error ? `<p class="text-red-400 text-sm mt-2">é”™è¯¯: ${ep.error}</p>` : ''}
        </div>
      `).join('');
    }

    // Show regenerate modal with user feedback input
    function showRegenerateModal(episodeNumber) {
      const existingModal = document.getElementById('regen-modal');
      if (existingModal) existingModal.remove();

      const modal = document.createElement('div');
      modal.id = 'regen-modal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4">
          <h3 class="text-lg font-bold mb-4">é‡æ–°ç”Ÿæˆç¬¬ ${episodeNumber} é›†å‰§æœ¬</h3>
          <div class="mb-4">
            <label class="block text-sm text-gray-400 mb-2">ä¿®æ”¹å»ºè®®ï¼ˆå¯é€‰ï¼‰</label>
            <textarea id="regen-feedback" class="w-full bg-gray-700 border border-gray-600 rounded p-3 text-sm" rows="4" placeholder="ä¾‹å¦‚ï¼šå¢åŠ æ›´å¤šå¯¹ç™½ã€æ—ç™½è¦æ›´ç”ŸåŠ¨ã€æŸä¸ªè§’è‰²çš„æˆä»½è¦å¢åŠ ..."></textarea>
          </div>
          <div class="flex justify-end gap-3">
            <button onclick="closeRegenerateModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">å–æ¶ˆ</button>
            <button onclick="regenerateEpisode(${episodeNumber})" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded" id="btn-regen-confirm-${episodeNumber}">ç¡®è®¤ç”Ÿæˆ</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Close regenerate modal
    function closeRegenerateModal() {
      const modal = document.getElementById('regen-modal');
      if (modal) modal.remove();
    }

    // Regenerate single episode script
    async function regenerateEpisode(episodeNumber) {
      if (!currentJob) return;

      const feedbackEl = document.getElementById('regen-feedback');
      const userFeedback = feedbackEl ? feedbackEl.value.trim() : '';

      // Close modal
      closeRegenerateModal();

      const btn = document.getElementById(`btn-regen-${episodeNumber}`);
      if (btn) {
        btn.textContent = 'â³ ç”Ÿæˆä¸­...';
        btn.disabled = true;
      }

      showStatus(`æ­£åœ¨é‡æ–°ç”Ÿæˆç¬¬ ${episodeNumber} é›†å‰§æœ¬...${userFeedback ? 'ï¼ˆåŒ…å«ä¿®æ”¹å»ºè®®ï¼‰' : ''}`);

      try {
        const response = await fetch(`${API_BASE}/api/script/generate/${currentJob.id}/episode/${episodeNumber}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userFeedback: userFeedback || null })
        });

        const data = await response.json();

        if (response.ok) {
          // Reload job and update tab
          currentJob = await (await fetch(`${API_BASE}/api/jobs/${currentJob.id}`)).json();
          updateScriptTab();
          showStatus(`ç¬¬ ${episodeNumber} é›†å‰§æœ¬å·²é‡æ–°ç”Ÿæˆï¼`);
        } else {
          showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      } catch (err) {
        showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + err.message, true);
      }

      if (btn) {
        btn.textContent = 'ğŸ”„ é‡æ–°ç”Ÿæˆ';
        btn.disabled = false;
      }
    }

    // Update Storyboard Tab
    function updateStoryboardTab() {
      const placeholder = document.getElementById('storyboard-placeholder');
      const content = document.getElementById('storyboard-content');

      if (!currentJob || !currentJob.script) {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
        return;
      }

      placeholder.classList.add('hidden');
      content.classList.remove('hidden');

      const storyboard = currentJob.storyboard;
      const failedEpisodes = storyboard?.failedEpisodes || [];
      if ((!storyboard || !storyboard.episodes?.length) && failedEpisodes.length === 0) {
        document.getElementById('storyboard-episodes').innerHTML = '<p class="text-gray-500 text-center py-8">ç‚¹å‡»"ç”Ÿæˆåˆ†é•œ"å¼€å§‹</p>';
        return;
      }

      const renderedEpisodes = storyboard?.episodes || [];
      const renderedEpisodeNumberSet = new Set(renderedEpisodes.map(ep => ep.episodeNumber));
      const failedEpisodeCards = failedEpisodes
        .filter(f => !renderedEpisodeNumberSet.has(f.episodeNumber))
        .sort((a, b) => a.episodeNumber - b.episodeNumber)
        .map(f => `
          <div class="bg-red-900/30 border border-red-700 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-start gap-3">
              <div>
                <h4 class="font-medium text-red-300">ç¬¬ ${f.episodeNumber} é›†åˆ†é•œç”Ÿæˆå¤±è´¥</h4>
                <p class="text-sm text-red-200 mt-1">${f.error || 'æœªçŸ¥é”™è¯¯'}</p>
                <p class="text-xs text-red-300/80 mt-1">${f.failedAt ? new Date(f.failedAt).toLocaleString() : ''}</p>
              </div>
              <button onclick="regenerateStoryboardEpisode(${f.episodeNumber})" id="btn-storyboard-regen-${f.episodeNumber}" class="text-xs bg-red-600 hover:bg-red-700 px-3 py-1 rounded whitespace-nowrap">
                ğŸ”„ é‡è¯•æœ¬é›†
              </button>
            </div>
          </div>
        `).join('');

      document.getElementById('storyboard-episodes').innerHTML = `
      ${failedEpisodeCards}
      ${renderedEpisodes.map(ep => `
        <div class="bg-gray-700 rounded-lg p-4">
          <div class="flex justify-between items-center mb-4 gap-3">
            <h4 class="font-medium">ç¬¬ ${ep.episodeNumber} é›† - ${ep.clips?.length || 0} ä¸ªç‰‡æ®µ</h4>
            <button onclick="regenerateStoryboardEpisode(${ep.episodeNumber})" id="btn-storyboard-regen-${ep.episodeNumber}" class="text-xs bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded whitespace-nowrap">
              ğŸ”„ é‡è¯•æœ¬é›†
            </button>
          </div>
          <div class="space-y-4">
            ${(ep.clips || []).map(clip => `
              <div class="clip-card bg-gray-800 rounded p-4 border border-gray-600">
                <div class="flex justify-between items-center mb-3">
                  <div>
                    <span class="font-medium text-blue-400">${clip.id}</span>
                    <span class="ml-2">${clip.title || 'æœªå‘½åç‰‡æ®µ'}</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-xs bg-gray-700 px-2 py-1 rounded">${clip.duration?.total || 0}s</span>
                    <span class="text-xs bg-purple-700 px-2 py-1 rounded">${clip.emotion || ''}</span>
                  </div>
                </div>

                <!-- æ„å›¾ -->
                ${clip.intent ? `<p class="text-sm text-gray-300 mb-3"><strong>æ„å›¾ï¼š</strong>${clip.intent}</p>` : ''}

                <!-- éŸ³é¢‘ä¿¡æ¯ -->
                ${(clip.narration || clip.dialogue || clip.bgm || clip.sfx) ? `
                <div class="mb-3 p-2 bg-gray-900 rounded border-l-4 border-amber-500">
                  ${clip.narration ? `<p class="text-sm mb-1"><strong class="text-amber-400">ğŸ™ï¸ æ—ç™½ï¼š</strong><span class="text-gray-300">"${clip.narration}"</span></p>` : ''}
                  ${clip.dialogue ? `<p class="text-sm mb-1"><strong class="text-green-400">ğŸ’¬ å¯¹ç™½ï¼š</strong><span class="text-gray-300">${clip.dialogue}</span></p>` : ''}
                  ${clip.bgm ? `<p class="text-sm mb-1"><strong class="text-blue-400">ğŸµ BGMï¼š</strong><span class="text-gray-400">${clip.bgm}</span></p>` : ''}
                  ${clip.sfx ? `<p class="text-sm"><strong class="text-purple-400">ğŸ”Š éŸ³æ•ˆï¼š</strong><span class="text-gray-400">${clip.sfx}</span></p>` : ''}
                </div>
                ` : ''}

                <!-- 5D æ¡†æ¶ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3 text-xs">
                  ${clip.prompt?.d1_subject ? `<div class="bg-gray-900 p-2 rounded"><strong class="text-red-400">D1 ä¸»ä½“:</strong> <span class="text-gray-300">${clip.prompt.d1_subject}</span></div>` : ''}
                  ${clip.prompt?.d2_environment ? `<div class="bg-gray-900 p-2 rounded"><strong class="text-green-400">D2 ç¯å¢ƒ:</strong> <span class="text-gray-300">${clip.prompt.d2_environment}</span></div>` : ''}
                  ${clip.prompt?.d3_material ? `<div class="bg-gray-900 p-2 rounded"><strong class="text-yellow-400">D3 æè´¨:</strong> <span class="text-gray-300">${clip.prompt.d3_material}</span></div>` : ''}
                  ${clip.prompt?.d4_camera ? `<div class="bg-gray-900 p-2 rounded"><strong class="text-blue-400">D4 é•œå¤´:</strong> <span class="text-gray-300">${clip.prompt.d4_camera}</span></div>` : ''}
                  ${clip.prompt?.d5_mood ? `<div class="bg-gray-900 p-2 rounded"><strong class="text-purple-400">D5 æ°›å›´:</strong> <span class="text-gray-300">${clip.prompt.d5_mood}</span></div>` : ''}
                </div>

                <!-- é•œå¤´æè¿° (ä¸­æ–‡) -->
                ${clip.camera ? `
                <div class="mb-3">
                  <strong class="text-sm text-cyan-400">é•œå¤´ä¸èŠ‚å¥ï¼š</strong>
                  <pre class="text-xs text-gray-300 bg-gray-900 p-2 rounded mt-1 whitespace-pre-wrap">${clip.camera}</pre>
                </div>
                ` : ''}

                <!-- å…³é”®å¸§å‚è€ƒ -->
                ${clip.prompt?.keyframeRef ? `
                <details class="mb-3">
                  <summary class="cursor-pointer text-sm text-cyan-400 hover:text-cyan-300">ğŸ–¼ï¸ å…³é”®å¸§å‚è€ƒ</summary>
                  <div class="text-xs bg-gray-900 p-3 rounded mt-2 space-y-2">
                    <p><strong class="text-gray-400">æè¿°:</strong> <span class="text-gray-300">${clip.prompt.keyframeRef.description || '-'}</span></p>
                    ${clip.prompt.keyframeRef.prompt ? `
                    <div>
                      <strong class="text-gray-400">è‹±æ–‡æç¤ºè¯:</strong>
                      <p class="text-green-300 mt-1 break-words">${clip.prompt.keyframeRef.prompt}</p>
                    </div>
                    ` : ''}
                    ${clip.prompt.keyframeRef.chinesePrompt ? `
                    <div>
                      <strong class="text-gray-400">ä¸­æ–‡æç¤ºè¯:</strong>
                      <p class="text-yellow-300 mt-1 break-words">${clip.prompt.keyframeRef.chinesePrompt}</p>
                    </div>
                    ` : ''}
                    <p><strong class="text-gray-400">æ„å›¾:</strong> <span class="text-gray-300">${clip.prompt.keyframeRef.composition || '-'}</span></p>
                    <p><strong class="text-gray-400">è‰²è°ƒ:</strong> <span class="text-gray-300">${clip.prompt.keyframeRef.colorPalette || '-'}</span></p>
                    <p><strong class="text-gray-400">å…‰çº¿å‚è€ƒ:</strong> <span class="text-gray-300">${clip.prompt.keyframeRef.lightingRef || '-'}</span></p>
                    <p><strong class="text-gray-400">æ°›å›´å‚è€ƒ:</strong> <span class="text-gray-300">${clip.prompt.keyframeRef.moodBoard || '-'}</span></p>
                    <p><strong class="text-gray-400">é£æ ¼å‚è€ƒ:</strong> <span class="text-gray-300">${clip.prompt.keyframeRef.styleRef || '-'}</span></p>
                  </div>
                </details>
                ` : ''}

                <!-- é”šç‚¹æ ‡è¯†ç¬¦ -->
                ${clip.prompt?.anchors?.characters?.length || clip.prompt?.anchors?.locations?.length ? `
                <details class="mb-3">
                  <summary class="cursor-pointer text-sm text-indigo-400 hover:text-indigo-300">ğŸ·ï¸ é”šç‚¹æ ‡è¯†ç¬¦</summary>
                  <div class="text-xs bg-gray-900 p-3 rounded mt-2 space-y-1">
                    ${clip.prompt.anchors.characters?.length ? `
                      <p><strong class="text-gray-400">è§’è‰²:</strong>
                        ${clip.prompt.anchors.characters.map(c => `<code class="bg-gray-700 px-1 rounded text-blue-300">${c.anchor}</code>`).join(' ')}
                      </p>
                    ` : ''}
                    ${clip.prompt.anchors.locations?.length ? `
                      <p><strong class="text-gray-400">åœºæ™¯:</strong>
                        ${clip.prompt.anchors.locations.map(l => `<code class="bg-gray-700 px-1 rounded text-green-300">${l.anchor}</code>`).join(' ')}
                      </p>
                    ` : ''}
                    ${clip.prompt.anchors.props?.length ? `
                      <p><strong class="text-gray-400">é“å…·:</strong>
                        ${clip.prompt.anchors.props.map(p => `<code class="bg-gray-700 px-1 rounded text-yellow-300">${p.anchor}</code>`).join(' ')}
                      </p>
                    ` : ''}
                  </div>
                </details>
                ` : ''}

                <!-- è½¬åœº -->
                ${clip.transition ? `<p class="text-xs text-gray-400 mb-3"><strong>è½¬åœºï¼š</strong>${clip.transition}</p>` : ''}

                <!-- ä¸­æ–‡æç¤ºè¯ -->
                ${clip.prompt?.chinese ? `
                <details class="mb-2">
                  <summary class="cursor-pointer text-sm text-emerald-400 hover:text-emerald-300">ğŸ‡¨ğŸ‡³ ä¸­æ–‡æç¤ºè¯ï¼ˆå«éŸ³é¢‘ï¼‰</summary>
                  <div class="text-xs text-gray-300 bg-gray-900 p-3 rounded mt-2 whitespace-pre-wrap">${clip.prompt.chinese}</div>
                </details>
                ` : ''}

                <!-- å®Œæ•´è‹±æ–‡æç¤ºè¯ -->
                <details class="mb-2">
                  <summary class="cursor-pointer text-sm text-gray-400 hover:text-gray-200">ğŸ“ è‹±æ–‡æç¤ºè¯ (combined)</summary>
                  <div class="prompt-box text-xs text-gray-300 bg-gray-900 p-3 rounded mt-2 whitespace-pre-wrap">${clip.prompt?.combined || 'æ— '}</div>
                </details>

                <!-- è´Ÿé¢æç¤ºè¯ -->
                ${clip.prompt?.negative ? `
                <details>
                  <summary class="cursor-pointer text-sm text-red-400 hover:text-red-300">ğŸš« è´Ÿé¢æç¤ºè¯</summary>
                  <div class="text-xs text-gray-400 bg-gray-900 p-3 rounded mt-2">${clip.prompt.negative}</div>
                </details>
                ` : ''}

                <!-- å»AIå‘³å…ƒç´  -->
                ${clip.prompt?.imperfections || clip.prompt?.randomWords || clip.prompt?.foregroundLayer ? `
                <details class="mt-2">
                  <summary class="cursor-pointer text-sm text-orange-400 hover:text-orange-300">âœ¨ å»AIå‘³å…ƒç´ </summary>
                  <div class="text-xs bg-gray-900 p-3 rounded mt-2 space-y-1">
                    ${clip.prompt.imperfections?.length ? `<p><strong class="text-gray-400">ç‘•ç–µ:</strong> ${clip.prompt.imperfections.join(', ')}</p>` : ''}
                    ${clip.prompt.randomWords?.length ? `<p><strong class="text-gray-400">éšæœºè¯:</strong> ${clip.prompt.randomWords.join(', ')}</p>` : ''}
                    ${clip.prompt.foregroundLayer ? `<p><strong class="text-gray-400">å‰æ™¯å±‚:</strong> ${clip.prompt.foregroundLayer}</p>` : ''}
                  </div>
                </details>
                ` : ''}

                <!-- å…³é”®å¸§å‚è€ƒ -->
                ${clip.prompt?.keyframeRef ? `
                <details class="mt-2">
                  <summary class="cursor-pointer text-sm text-cyan-400 hover:text-cyan-300">ğŸ–¼ï¸ å…³é”®å¸§å‚è€ƒ</summary>
                  <div class="text-xs bg-gray-900 p-3 rounded mt-2 space-y-2">
                    <p><strong class="text-gray-400">æè¿°:</strong> ${clip.prompt.keyframeRef.description || '-'}</p>
                    ${clip.prompt.keyframeRef.prompt ? `
                    <div>
                      <strong class="text-gray-400">è‹±æ–‡æç¤ºè¯:</strong>
                      <p class="text-green-300 mt-1 break-words">${clip.prompt.keyframeRef.prompt}</p>
                    </div>
                    ` : ''}
                    ${clip.prompt.keyframeRef.chinesePrompt ? `
                    <div>
                      <strong class="text-gray-400">ä¸­æ–‡æç¤ºè¯:</strong>
                      <p class="text-yellow-300 mt-1 break-words">${clip.prompt.keyframeRef.chinesePrompt}</p>
                    </div>
                    ` : ''}
                    <p><strong class="text-gray-400">æ„å›¾:</strong> ${clip.prompt.keyframeRef.composition || '-'}</p>
                    <p><strong class="text-gray-400">è‰²å½©:</strong> ${clip.prompt.keyframeRef.colorPalette || '-'}</p>
                    <p><strong class="text-gray-400">å…‰çº¿:</strong> ${clip.prompt.keyframeRef.lightingRef || '-'}</p>
                    <p><strong class="text-gray-400">æ°›å›´:</strong> ${clip.prompt.keyframeRef.moodBoard || '-'}</p>
                    <p><strong class="text-gray-400">é£æ ¼:</strong> ${clip.prompt.keyframeRef.styleRef || '-'}</p>
                  </div>
                </details>
                ` : ''}

                <!-- é”šç‚¹æ ‡è¯†ç¬¦ -->
                ${clip.prompt?.anchors?.characters?.length || clip.prompt?.anchors?.locations?.length ? `
                <details class="mt-2">
                  <summary class="cursor-pointer text-sm text-indigo-400 hover:text-indigo-300">ğŸ·ï¸ é”šç‚¹æ ‡è¯†ç¬¦</summary>
                  <div class="text-xs bg-gray-900 p-3 rounded mt-2 space-y-1">
                    ${clip.prompt.anchors.characters?.length ? `<p><strong class="text-gray-400">è§’è‰²:</strong> ${clip.prompt.anchors.characters.map(c => c.anchor).join(', ')}</p>` : ''}
                    ${clip.prompt.anchors.locations?.length ? `<p><strong class="text-gray-400">åœºæ™¯:</strong> ${clip.prompt.anchors.locations.map(l => l.anchor).join(', ')}</p>` : ''}
                  </div>
                </details>
                ` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `).join('')}
      `;
    }

    // Update Assets Tab
    function updateAssetsTab() {
      const placeholder = document.getElementById('assets-placeholder');
      const content = document.getElementById('assets-content');

      if (!currentJob || !currentJob.storyBible) {
        placeholder.classList.remove('hidden');
        content.classList.add('hidden');
        return;
      }

      placeholder.classList.add('hidden');
      content.classList.remove('hidden');

      const assets = currentJob.assets;
      if (!assets) {
        document.getElementById('assets-characters').innerHTML = '<p class="text-gray-500 text-sm">ç‚¹å‡»"ç”Ÿæˆèµ„äº§"</p>';
        document.getElementById('assets-scenes').innerHTML = '<p class="text-gray-500 text-sm">ç‚¹å‡»"ç”Ÿæˆèµ„äº§"</p>';
        document.getElementById('assets-props').innerHTML = '<p class="text-gray-500 text-sm">ç‚¹å‡»"ç”Ÿæˆèµ„äº§"</p>';
        return;
      }

      // è§’è‰²èµ„äº§ - å¯ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
      document.getElementById('assets-characters').innerHTML = (assets.characters || []).map((c, idx) => `
        <div class="bg-gray-600 rounded p-3 cursor-pointer hover:bg-gray-500 transition-colors"
             onclick="showCharacterAsset(${idx})">
          <div class="font-medium text-sm mb-1">${c.characterName}</div>
          <div class="text-xs text-gray-400 flex items-center gap-1">
            <span class="text-blue-400">ğŸ“„</span> ç‚¹å‡»æŸ¥çœ‹æç¤ºè¯
          </div>
          ${c.turnaround ? '<div class="text-xs text-green-400 mt-1">âœ“ å››è§†å›¾</div>' : ''}
          ${c.expressions ? '<div class="text-xs text-purple-400">âœ“ è¡¨æƒ…å‚è€ƒ</div>' : ''}
        </div>
      `).join('') || '<p class="text-gray-500 text-sm">æš‚æ— è§’è‰²èµ„äº§</p>';

      // åœºæ™¯èµ„äº§ - å¯ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
      document.getElementById('assets-scenes').innerHTML = (assets.scenes || []).map((s, idx) => `
        <div class="bg-gray-600 rounded p-3 cursor-pointer hover:bg-gray-500 transition-colors"
             onclick="showSceneAsset(${idx})">
          <div class="font-medium text-sm mb-1">${s.sceneName}</div>
          <div class="text-xs text-gray-400">${s.mood || s.lighting || 'åœºæ™¯å‚è€ƒ'}</div>
          ${s.variations ? '<div class="text-xs text-green-400 mt-1">âœ“ å¤šè§†è§’</div>' : ''}
        </div>
      `).join('') || '<p class="text-gray-500 text-sm">æš‚æ— åœºæ™¯èµ„äº§</p>';

      // é“å…·èµ„äº§ - å¯ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
      document.getElementById('assets-props').innerHTML = (assets.props || []).map((p, idx) => `
        <div class="bg-gray-600 rounded p-3 cursor-pointer hover:bg-gray-500 transition-colors"
             onclick="showPropAsset(${idx})">
          <div class="font-medium text-sm mb-1">${p.propName}</div>
          <div class="text-xs text-gray-400">${p.material || 'é“å…·å‚è€ƒ'}</div>
          ${p.views ? '<div class="text-xs text-green-400 mt-1">âœ“ å¤šè§†è§’</div>' : ''}
        </div>
      `).join('') || '<p class="text-gray-500 text-sm">æš‚æ— é“å…·èµ„äº§</p>';
    }

    // æ˜¾ç¤ºè§’è‰²èµ„äº§è¯¦æƒ…å¼¹çª—
    function showCharacterAsset(idx) {
      const assets = currentJob?.assets;
      if (!assets || !assets.characters || !assets.characters[idx]) return;

      const c = assets.characters[idx];
      document.getElementById('modal-title').textContent = `è§’è‰²èµ„äº§: ${c.characterName}`;

      let html = `
        <div class="space-y-4">
          <!-- åŸºç¡€æç¤ºè¯ -->
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-blue-400">åŸºç¡€æè¿°</h4>
            <pre class="text-xs text-gray-300 whitespace-pre-wrap">${c.basePrompt || 'æ— '}</pre>
          </div>

          <!-- å˜ä½“ -->
          ${c.variations ? `
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-green-400">è§’è‰²å˜ä½“</h4>
            <div class="space-y-2">
              ${Object.entries(c.variations).map(([key, v]) => `
                <details class="bg-gray-800 rounded">
                  <summary class="cursor-pointer p-2 text-sm text-gray-300 hover:text-white">${v.description || key}</summary>
                  <div class="p-2 border-t border-gray-700">
                    <p class="text-xs text-gray-400 mb-1">Prompt:</p>
                    <pre class="text-xs text-gray-300 whitespace-pre-wrap">${v.prompt || 'æ— '}</pre>
                    ${v.negative ? `<p class="text-xs text-red-400 mt-2">Negative: ${v.negative}</p>` : ''}
                  </div>
                </details>
              `).join('')}
            </div>
          </div>
          ` : ''}

          <!-- å››è§†å›¾ -->
          ${c.turnaround ? `
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-purple-400">å››è§†å›¾ (Turnaround)</h4>
            <div class="grid grid-cols-2 gap-2 mb-3">
              ${Object.entries(c.turnaround.views || {}).map(([key, view]) => `
                <div class="bg-gray-800 rounded p-2">
                  <div class="text-xs font-medium text-gray-400 mb-1">${view.angleCn || view.angle}</div>
                  <pre class="text-xs text-gray-300 whitespace-pre-wrap">${view.prompt || ''}</pre>
                </div>
              `).join('')}
            </div>
            <details>
              <summary class="cursor-pointer text-sm text-gray-400">æ•´åˆå››è§†å›¾æç¤ºè¯</summary>
              <pre class="text-xs text-gray-300 whitespace-pre-wrap mt-2">${c.turnaround.combinedPrompt || ''}</pre>
            </details>
            <details class="mt-2">
              <summary class="cursor-pointer text-sm text-red-400">Negative Prompt</summary>
              <pre class="text-xs text-gray-400 whitespace-pre-wrap mt-2">${c.turnaround.negativePrompt || ''}</pre>
            </details>
          </div>
          ` : ''}

          <!-- è¡¨æƒ…å‚è€ƒ -->
          ${c.expressions ? `
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-yellow-400">è¡¨æƒ…å‚è€ƒ (${c.expressions.expressions?.length || 0}ç§)</h4>
            <div class="grid grid-cols-3 gap-2 mb-3">
              ${(c.expressions.expressions || []).map(expr => `
                <div class="bg-gray-800 rounded p-2">
                  <div class="text-xs font-medium text-gray-300 mb-1">${expr.name}</div>
                  <div class="text-xs text-gray-500">${expr.description}</div>
                </div>
              `).join('')}
            </div>
            <details>
              <summary class="cursor-pointer text-sm text-gray-400">æ•´åˆè¡¨æƒ…å›¾æç¤ºè¯</summary>
              <pre class="text-xs text-gray-300 whitespace-pre-wrap mt-2">${c.expressions.combinedPrompt || ''}</pre>
            </details>
          </div>
          ` : ''}

          <!-- å…³é”®ç‰¹å¾ -->
          ${c.keyFeatures?.length ? `
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-orange-400">å…³é”®ç‰¹å¾</h4>
            <div class="flex gap-2 flex-wrap">
              ${c.keyFeatures.map(f => `<span class="text-xs bg-gray-600 px-2 py-1 rounded">${f}</span>`).join('')}
            </div>
          </div>
          ` : ''}

          <!-- è‰²å½© -->
          ${c.colorPalette ? `
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-pink-400">è‰²å½©æ–¹æ¡ˆ</h4>
            <div class="flex gap-4 text-xs">
              <span>ä¸»è‰²: ${c.colorPalette.primary || '-'}</span>
              <span>è¾…è‰²: ${c.colorPalette.secondary || '-'}</span>
              <span>å¼ºè°ƒ: ${c.colorPalette.accent || '-'}</span>
            </div>
          </div>
          ` : ''}
        </div>
      `;

      document.getElementById('modal-content').innerHTML = html;
      document.getElementById('asset-modal').classList.remove('hidden');
    }

    // æ˜¾ç¤ºåœºæ™¯èµ„äº§è¯¦æƒ…å¼¹çª—
    function showSceneAsset(idx) {
      const assets = currentJob?.assets;
      if (!assets || !assets.scenes || !assets.scenes[idx]) return;

      const s = assets.scenes[idx];
      document.getElementById('modal-title').textContent = `åœºæ™¯èµ„äº§: ${s.sceneName}`;

      let html = `
        <div class="space-y-4">
          <!-- åŸºç¡€æè¿° -->
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-blue-400">åŸºç¡€æè¿°</h4>
            <pre class="text-xs text-gray-300 whitespace-pre-wrap">${s.basePrompt || 'æ— '}</pre>
          </div>

          <!-- åœºæ™¯ä¿¡æ¯ -->
          <div class="bg-gray-700 rounded p-3">
            <div class="grid grid-cols-3 gap-4 text-xs">
              <div><span class="text-gray-400">æ—¶é—´:</span> ${s.time || '-'}</div>
              <div><span class="text-gray-400">å¤©æ°”:</span> ${s.weather || '-'}</div>
              <div><span class="text-gray-400">æ°›å›´:</span> ${s.mood || '-'}</div>
            </div>
          </div>

          <!-- å˜ä½“ -->
          ${s.variations ? `
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-green-400">åœºæ™¯è§†è§’</h4>
            <div class="space-y-2">
              ${Object.entries(s.variations).map(([key, v]) => `
                <details class="bg-gray-800 rounded">
                  <summary class="cursor-pointer p-2 text-sm text-gray-300 hover:text-white">${key}</summary>
                  <div class="p-2 border-t border-gray-700">
                    <pre class="text-xs text-gray-300 whitespace-pre-wrap">${v.prompt || 'æ— '}</pre>
                    ${v.negative ? `<p class="text-xs text-red-400 mt-2">Negative: ${v.negative}</p>` : ''}
                  </div>
                </details>
              `).join('')}
            </div>
          </div>
          ` : ''}

          <!-- æ—¶é—´å˜ä½“ -->
          ${s.timeVariants ? `
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-purple-400">æ—¶é—´å˜ä½“</h4>
            <div class="space-y-2">
              ${s.timeVariants.map(tv => `
                <details class="bg-gray-800 rounded">
                  <summary class="cursor-pointer p-2 text-sm text-gray-300 hover:text-white">${tv.time}</summary>
                  <pre class="text-xs text-gray-300 whitespace-pre-wrap p-2">${tv.prompt || ''}</pre>
                </details>
              `).join('')}
            </div>
          </div>
          ` : ''}

          <!-- Negative -->
          ${s.negativePrompt ? `
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-red-400">Negative Prompt</h4>
            <pre class="text-xs text-gray-400 whitespace-pre-wrap">${s.negativePrompt}</pre>
          </div>
          ` : ''}
        </div>
      `;

      document.getElementById('modal-content').innerHTML = html;
      document.getElementById('asset-modal').classList.remove('hidden');
    }

    // æ˜¾ç¤ºé“å…·èµ„äº§è¯¦æƒ…å¼¹çª—
    function showPropAsset(idx) {
      const assets = currentJob?.assets;
      if (!assets || !assets.props || !assets.props[idx]) return;

      const p = assets.props[idx];
      document.getElementById('modal-title').textContent = `é“å…·èµ„äº§: ${p.propName}`;

      let html = `
        <div class="space-y-4">
          <!-- åŸºç¡€æè¿° -->
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-blue-400">åŸºç¡€æè¿°</h4>
            <pre class="text-xs text-gray-300 whitespace-pre-wrap">${p.basePrompt || 'æ— '}</pre>
          </div>

          <!-- é“å…·ä¿¡æ¯ -->
          ${p.materials?.length || p.colors?.length ? `
          <div class="bg-gray-700 rounded p-3">
            <div class="grid grid-cols-2 gap-4 text-xs">
              <div><span class="text-gray-400">æè´¨:</span> ${(p.materials || []).join(', ') || '-'}</div>
              <div><span class="text-gray-400">é¢œè‰²:</span> ${(p.colors || []).join(', ') || '-'}</div>
            </div>
          </div>
          ` : ''}

          <!-- è§†è§’ -->
          ${p.views ? `
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-green-400">é“å…·è§†è§’</h4>
            <div class="space-y-2">
              ${Object.entries(p.views).map(([key, v]) => `
                <details class="bg-gray-800 rounded">
                  <summary class="cursor-pointer p-2 text-sm text-gray-300 hover:text-white">${key}</summary>
                  <div class="p-2 border-t border-gray-700">
                    <pre class="text-xs text-gray-300 whitespace-pre-wrap">${v.prompt || 'æ— '}</pre>
                    ${v.negative ? `<p class="text-xs text-red-400 mt-2">Negative: ${v.negative}</p>` : ''}
                  </div>
                </details>
              `).join('')}
            </div>
          </div>
          ` : ''}

          <!-- Negative -->
          ${p.negativePrompt ? `
          <div class="bg-gray-700 rounded p-3">
            <h4 class="font-medium text-sm mb-2 text-red-400">Negative Prompt</h4>
            <pre class="text-xs text-gray-400 whitespace-pre-wrap">${p.negativePrompt}</pre>
          </div>
          ` : ''}
        </div>
      `;

      document.getElementById('modal-content').innerHTML = html;
      document.getElementById('asset-modal').classList.remove('hidden');
    }

    // å…³é—­èµ„äº§å¼¹çª—
    function closeAssetModal() {
      document.getElementById('asset-modal').classList.add('hidden');
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.getElementById('asset-modal').addEventListener('click', (e) => {
      if (e.target.id === 'asset-modal') {
        closeAssetModal();
      }
    });

    // Export
    function exportJob(format) {
      if (!currentJob) return;
      window.open(`${API_BASE}/api/export/${currentJob.id}/${format}`, '_blank');
    }

    // Status bar
    function showStatus(message, isError = false) {
      const statusBar = document.getElementById('status-bar');
      const statusMessage = document.getElementById('status-message');
      statusBar.classList.remove('hidden');
      statusMessage.textContent = message;
      statusMessage.className = isError ? 'text-red-400' : 'text-gray-300';
    }

    function hideStatus() {
      document.getElementById('status-bar').classList.add('hidden');
    }

    // Initialize
    showTab('upload');
  </script>
</body>
</html>
